import React, { useState, useEffect, useRef } from 'react';

// --- å›¾æ ‡ç»„ä»¶ ---
const Icons = {
    Back: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
    Eye: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
    Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
    Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
    Ear: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8.5a6.5 6.5 0 1 1 13 0c0 6-6 6-6 10a3.5 3.5 0 1 1-7 0"/><path d="M15 8.5a2.5 2.5 0 0 0-5 0v1a2 2 0 1 0 4 0v-1"/></svg>,
    PenTool: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
    Split: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.87l-4.243-4.242a2 2 0 0 1-.585-1.414V3"/><path d="m20 22-5-5"/><path d="m15 22 5-5"/></svg>,
    BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
};

// --- é€šç”¨ UI ç»„ä»¶ ---
const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, size = 'md' }) => {
    const sizeStyle = size === 'sm' ? "px-3 py-1.5 text-sm" : "px-6 py-3 text-base";
    const baseStyle = `rounded-xl font-bold transition-all active:scale-95 flex items-center justify-center gap-2 select-none shadow-sm ${sizeStyle}`;
    const variants = {
        primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
        secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 disabled:bg-gray-100",
        danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100"
    };
    return (
        <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
            {children}
        </button>
    );
};

// --- ç»Ÿä¸€çš„æ¸¸æˆå¸ƒå±€å®¹å™¨ (è§£å†³å¯¼èˆªå’Œé«˜åº¦é—®é¢˜) ---
const GameLayout = ({ title, icon: Icon, onBack, children, headerRight }) => (
    <div className="flex flex-col h-full bg-gray-50">
        {/* é¡¶éƒ¨å¸¸é©»å¯¼èˆªæ  */}
        <div className="bg-white px-4 py-3 shadow-sm flex items-center justify-between shrink-0 z-10 sticky top-0">
            <div className="flex items-center gap-3">
                <button 
                    onClick={onBack} 
                    className="p-2 -ml-2 rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors"
                >
                    <Icons.Back />
                </button>
                <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                    {Icon && <Icon />} {title}
                </h2>
            </div>
            <div>{headerRight}</div>
        </div>

        {/* æ»šåŠ¨å†…å®¹åŒº */}
        <div className="flex-1 overflow-y-auto p-4 scrollbar-hide">
            <div className="max-w-md mx-auto h-full flex flex-col">
                {children}
            </div>
        </div>
    </div>
);

// --- æ¨¡å—1: èˆ’å°”ç‰¹æ–¹æ ¼ ---
const SchulteGame = ({ onBack }) => {
    const [grid, setGrid] = useState([]);
    const [nextNum, setNextNum] = useState(1);
    const [startTime, setStartTime] = useState(null);
    const [time, setTime] = useState(0);
    const [gameState, setGameState] = useState('intro');

    const initGame = () => {
        const nums = Array.from({ length: 25 }, (_, i) => i + 1);
        for (let i = nums.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [nums[i], nums[j]] = [nums[j], nums[i]];
        }
        setGrid(nums);
        setNextNum(1);
        setStartTime(Date.now());
        setTime(0);
        setGameState('playing');
    };

    useEffect(() => {
        let interval;
        if (gameState === 'playing') {
            interval = setInterval(() => {
                setTime(((Date.now() - startTime) / 1000).toFixed(2));
            }, 50);
        }
        return () => clearInterval(interval);
    }, [gameState, startTime]);

    const handleTap = (num) => {
        if (num === nextNum) {
            if (num === 25) { setGameState('finished'); } 
            else { setNextNum(prev => prev + 1); }
        }
    };

    return (
        <GameLayout title="è§†è§‰æœç´¢" icon={Icons.Eye} onBack={onBack} headerRight={<span className="font-mono font-bold text-blue-600">{time}s</span>}>
            {gameState === 'intro' && (
                <div className="flex-1 flex flex-col justify-center items-center text-center">
                    <div className="bg-white p-6 rounded-2xl shadow-sm mb-8 w-full">
                        <p className="text-lg text-gray-600 mb-6">æŒ‰ 1-25 é¡ºåºå¿«é€Ÿç‚¹å‡»</p>
                        <Button onClick={initGame} className="w-full">å¼€å§‹è®¡æ—¶</Button>
                    </div>
                </div>
            )}

            {gameState === 'playing' && (
                <div className="flex-1 flex flex-col justify-center">
                    <div className="grid grid-cols-5 gap-2 aspect-square w-full">
                        {grid.map((num) => (
                            <button
                                key={num}
                                onTouchStart={(e) => { e.preventDefault(); handleTap(num); }}
                                onClick={() => handleTap(num)}
                                className={`
                                    rounded-lg text-xl font-bold flex items-center justify-center shadow-sm transition-all select-none
                                    ${num < nextNum ? 'bg-green-100 text-green-300' : 'bg-white text-gray-800 active:scale-95 active:bg-gray-100'}
                                `}
                            >
                                {num}
                            </button>
                        ))}
                    </div>
                </div>
            )}

            {gameState === 'finished' && (
                <div className="flex-1 flex flex-col justify-center items-center text-center">
                    <div className="bg-white p-8 rounded-2xl shadow-sm w-full">
                        <div className="text-6xl mb-4">ğŸ†</div>
                        <h3 className="text-2xl font-bold mb-2">å®Œæˆ!</h3>
                        <p className="text-gray-500 mb-8">æˆç»©: <span className="text-blue-600 font-bold text-xl">{time}ç§’</span></p>
                        <Button onClick={initGame} className="w-full mb-3">å†æ¥ä¸€æ¬¡</Button>
                    </div>
                </div>
            )}
        </GameLayout>
    );
};

// --- æ¨¡å—2: Stroop æµ‹è¯• ---
const StroopGame = ({ onBack }) => {
    const colors = [
        { name: 'çº¢', code: 'text-red-500', value: 'red' },
        { name: 'ç»¿', code: 'text-green-500', value: 'green' },
        { name: 'è“', code: 'text-blue-500', value: 'blue' },
        { name: 'é»„', code: 'text-yellow-500', value: 'yellow' }
    ];
    
    const [currentWord, setCurrentWord] = useState({});
    const [score, setScore] = useState(0);
    const [timeLeft, setTimeLeft] = useState(30);
    const [isActive, setIsActive] = useState(false);
    const [feedback, setFeedback] = useState(null);

    const nextRound = () => {
        const randomText = colors[Math.floor(Math.random() * colors.length)];
        let randomColor = colors[Math.floor(Math.random() * colors.length)];
        setCurrentWord({ text: randomText.name, colorClass: randomColor.code, colorValue: randomColor.value });
    };

    const startGame = () => {
        setScore(0);
        setTimeLeft(30);
        setIsActive(true);
        nextRound();
    };

    useEffect(() => {
        let timer;
        if (isActive && timeLeft > 0) {
            timer = setTimeout(() => setTimeLeft(prev => prev - 1), 1000);
        } else if (timeLeft === 0) {
            setIsActive(false);
        }
        return () => clearTimeout(timer);
    }, [isActive, timeLeft]);

    const handleChoice = (colorValue) => {
        if (colorValue === currentWord.colorValue) {
            setScore(prev => prev + 1);
            setFeedback('correct');
        } else {
            setFeedback('wrong');
        }
        setTimeout(() => setFeedback(null), 200);
        nextRound();
    };

    return (
        <GameLayout title="Stroopæµ‹è¯•" icon={Icons.Zap} onBack={onBack} headerRight={<div className="text-right"><div className="text-xs text-gray-500">å¾—åˆ†: {score}</div><div className="font-mono font-bold text-blue-600">{timeLeft}s</div></div>}>
            {!isActive && timeLeft === 30 && (
                 <div className="flex-1 flex flex-col justify-center items-center">
                    <div className="bg-white p-6 rounded-2xl shadow-sm w-full text-center">
                        <p className="mb-6 text-lg text-gray-600">ç‚¹å‡»æ–‡å­—çš„<span className="font-bold text-red-500">é¢œè‰²</span><br/>ä¸è¦ç‚¹å‡»æ–‡å­—å†…å®¹</p>
                        <Button onClick={startGame} className="w-full">å¼€å§‹æŒ‘æˆ˜</Button>
                    </div>
                </div>
            )}

            {isActive && (
                <div className="flex-1 flex flex-col">
                    <div className="flex-1 flex items-center justify-center">
                        <div className={`text-8xl font-black transition-all select-none ${currentWord.colorClass} ${feedback === 'wrong' ? 'animate-shake' : ''}`}>
                            {currentWord.text}
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 pb-4">
                        <Button onClick={() => handleChoice('red')} className="bg-red-50 text-red-600 border-none h-20 text-xl">çº¢è‰²</Button>
                        <Button onClick={() => handleChoice('green')} className="bg-green-50 text-green-600 border-none h-20 text-xl">ç»¿è‰²</Button>
                        <Button onClick={() => handleChoice('blue')} className="bg-blue-50 text-blue-600 border-none h-20 text-xl">è“è‰²</Button>
                        <Button onClick={() => handleChoice('yellow')} className="bg-yellow-50 text-yellow-600 border-none h-20 text-xl">é»„è‰²</Button>
                    </div>
                </div>
            )}

            {!isActive && timeLeft === 0 && (
                <div className="flex-1 flex flex-col justify-center items-center">
                    <div className="bg-white p-8 rounded-2xl shadow-sm w-full text-center">
                        <h3 className="text-2xl font-bold mb-2">æ—¶é—´åˆ°!</h3>
                        <p className="text-gray-500 mb-8">æœ€ç»ˆå¾—åˆ†: <span className="text-blue-600 font-bold text-3xl">{score}</span></p>
                        <Button onClick={startGame} className="w-full">å†è¯•ä¸€æ¬¡</Button>
                    </div>
                </div>
            )}
        </GameLayout>
    );
};

// --- æ¨¡å—3: åºåˆ—è®°å¿† ---
const MemoryGame = ({ onBack }) => {
    const items = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸš—', 'ğŸ¶', 'ğŸ±', 'âš½', 'â°', 'ğŸ¸', 'ğŸ¦'];
    const [sequence, setSequence] = useState([]);
    const [userSequence, setUserSequence] = useState([]);
    const [level, setLevel] = useState(3);
    const [phase, setPhase] = useState('intro');

    const startLevel = () => {
        const newSeq = [];
        for(let i=0; i<level; i++) {
            newSeq.push(items[Math.floor(Math.random() * items.length)]);
        }
        setSequence(newSeq);
        setUserSequence([]);
        setPhase('showing');
    };

    useEffect(() => {
        if (phase === 'showing') {
            const timer = setTimeout(() => {
                setPhase('recall');
            }, 1000 * Math.max(2, level * 0.8));
            return () => clearTimeout(timer);
        }
    }, [phase, level]);

    const handleItemClick = (item) => {
        const newSeq = [...userSequence, item];
        setUserSequence(newSeq);
        if (newSeq.length === sequence.length) {
            checkResult(newSeq);
        }
    };

    const checkResult = (finalSeq) => {
        const isCorrect = finalSeq.every((val, index) => val === sequence[index]);
        if (isCorrect) {
            setTimeout(() => {
                alert('æ­£ç¡®ï¼è¿›å…¥ä¸‹ä¸€å…³');
                setLevel(prev => prev + 1);
                startLevel();
            }, 200);
        } else {
            setPhase('result');
        }
    };

    return (
        <GameLayout title="åºåˆ—è®°å¿†" icon={Icons.Brain} onBack={onBack} headerRight={<span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Lv.{level-2}</span>}>
            {phase === 'intro' && (
                <div className="flex-1 flex flex-col justify-center items-center">
                    <div className="bg-white p-6 rounded-2xl shadow-sm w-full text-center">
                        <p className="mb-6 text-lg text-gray-600">è®°ä½ç‰©å“å‡ºç°çš„<span className="font-bold">é¡ºåº</span></p>
                        <Button onClick={startLevel} className="w-full">å¼€å§‹ Lv.1</Button>
                    </div>
                </div>
            )}

            {phase === 'showing' && (
                 <div className="flex-1 flex flex-col items-center justify-center">
                     <div className="text-gray-500 mb-8 animate-pulse font-bold">è¯·è®°å¿†...</div>
                     <div className="flex flex-wrap gap-4 justify-center">
                         {sequence.map((item, idx) => (
                             <div key={idx} className="w-16 h-16 bg-white rounded-2xl shadow-sm border border-gray-100 flex items-center justify-center text-3xl animate-[popIn_0.3s_ease-out]" style={{animationDelay: `${idx*0.2}s`}}>
                                {item}
                             </div>
                         ))}
                     </div>
                 </div>
            )}

            {phase === 'recall' && (
                <div className="flex-1 flex flex-col">
                    <div className="mb-4 bg-white border border-gray-200 rounded-xl p-4 flex gap-2 flex-wrap items-center min-h-[80px]">
                        {userSequence.map((item, idx) => (
                            <span key={idx} className="text-2xl animate-[popIn_0.2s_ease-out]">{item}</span>
                        ))}
                        {userSequence.length === 0 && <span className="text-gray-400 text-sm">ç‚¹å‡»ä¸‹æ–¹ç‰©å“...</span>}
                    </div>
                    <div className="grid grid-cols-5 gap-2">
                        {items.map((item) => (
                            <button key={item} onClick={() => handleItemClick(item)} className="aspect-square bg-white rounded-xl border border-gray-200 shadow-sm text-2xl active:bg-gray-100 transition-colors">
                                {item}
                            </button>
                        ))}
                    </div>
                    <div className="mt-4 text-right">
                        <button onClick={() => setUserSequence([])} className="text-red-500 text-sm font-medium px-4 py-2">é‡ç½®é€‰æ‹©</button>
                    </div>
                </div>
            )}

            {phase === 'result' && (
                <div className="flex-1 flex flex-col justify-center items-center">
                    <div className="bg-white p-8 rounded-2xl shadow-sm w-full text-center">
                        <div className="text-5xl mb-4">âŒ</div>
                        <h3 className="text-xl font-bold mb-2">è®°å¿†é”™è¯¯</h3>
                        <div className="bg-gray-50 p-3 rounded-lg text-sm text-gray-500 mb-6 break-words">
                            æ­£ç¡®: {sequence.join(' ')}
                        </div>
                        <Button onClick={() => { setLevel(3); startLevel(); }} className="w-full">é‡å¤´å¼€å§‹</Button>
                    </div>
                </div>
            )}
        </GameLayout>
    );
};

// --- æ¨¡å—4: å¬è§‰ä¸“æ³¨ (å¢å¼ºç‰ˆ) ---
const AuditoryGame = ({ onBack }) => {
    const [isPlaying, setIsPlaying] = useState(false);
    const [targetNum, setTargetNum] = useState(null);
    const [sequence, setSequence] = useState([]);
    const [userInput, setUserInput] = useState('');
    const [result, setResult] = useState(null); 
    // æ’­æ”¾é€Ÿåº¦çŠ¶æ€ï¼Œé»˜è®¤1.0
    const [speechRate, setSpeechRate] = useState(1.0);

    const generateGame = () => {
        const target = Math.floor(Math.random() * 9) + 1;
        setTargetNum(target);
        
        const length = 15; // å›ºå®šé•¿åº¦ï¼Œä¸»è¦é é€Ÿåº¦è°ƒèŠ‚éš¾åº¦
        const count = 3 + Math.floor(Math.random() * 4);
        let seq = Array.from({length}, () => Math.floor(Math.random() * 9) + 1);
        
        let currentCount = seq.filter(n => n === target).length;
        while(currentCount !== count) {
             seq = Array.from({length}, () => Math.floor(Math.random() * 9) + 1);
             currentCount = seq.filter(n => n === target).length;
        }

        setSequence({ data: seq, answer: count });
        setResult(null);
        setUserInput('');
        playSequence(seq);
    };

    const playSequence = (seq) => {
        setIsPlaying(true);
        if (!window.speechSynthesis) {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½');
            return;
        }

        // ç¡®ä¿å–æ¶ˆä¹‹å‰çš„æ’­æ”¾
        window.speechSynthesis.cancel();

        let i = 0;
        const speakNext = () => {
            if (i >= seq.length) {
                setIsPlaying(false);
                return;
            }
            const num = seq[i];
            const utterance = new SpeechSynthesisUtterance(num.toString());
            // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„é€Ÿåº¦
            utterance.rate = speechRate; 
            utterance.lang = 'zh-CN';
            
            utterance.onend = () => {
                i++;
                // é—´éš”ä¹Ÿéšé€Ÿåº¦å˜åŒ–
                setTimeout(speakNext, 300 / speechRate);
            };
            window.speechSynthesis.speak(utterance);
        };
        speakNext();
    };

    const checkAnswer = () => {
        if (parseInt(userInput) === sequence.answer) {
            setResult('correct');
        } else {
            setResult('wrong');
        }
    };

    return (
        <GameLayout title="å¬è§‰ä¸“æ³¨" icon={Icons.Ear} onBack={onBack}>
            {!targetNum ? (
                <div className="flex-1 flex flex-col justify-center items-center">
                     <div className="bg-white p-6 rounded-2xl shadow-sm w-full text-center mb-6">
                        <p className="text-gray-600 mb-6">
                            ç»Ÿè®¡æ•°å­— <span className="font-bold text-blue-600 text-lg">X</span> å‡ºç°æ¬¡æ•°
                        </p>
                        
                        {/* é€Ÿåº¦è°ƒèŠ‚å™¨ */}
                        <div className="mb-6 bg-gray-50 p-4 rounded-xl">
                            <div className="flex justify-between text-sm text-gray-500 mb-2">
                                <span>æ…¢é€Ÿ (0.5x)</span>
                                <span className="font-bold text-blue-600">{speechRate}x</span>
                                <span>æé€Ÿ (2.0x)</span>
                            </div>
                            <input 
                                type="range" 
                                min="0.5" 
                                max="2.0" 
                                step="0.1" 
                                value={speechRate}
                                onChange={(e) => setSpeechRate(parseFloat(e.target.value))}
                                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                            />
                        </div>

                        <Button onClick={generateGame} className="w-full">å¼€å§‹è®­ç»ƒ</Button>
                    </div>
                </div>
            ) : (
                <div className="flex flex-col h-full">
                    <div className="flex-1 flex flex-col items-center justify-center">
                        <div className="text-center mb-8">
                            <p className="text-gray-500 mb-2">ç»Ÿè®¡ç›®æ ‡æ•°å­—</p>
                            <div className="text-7xl font-bold text-blue-600">{targetNum}</div>
                        </div>

                        {isPlaying ? (
                            <div className="h-20 flex flex-col items-center justify-center">
                                <div className="flex gap-1 h-8 items-end mb-2">
                                     <div className="w-1.5 bg-blue-500 animate-[bounce_1s_infinite] h-4"></div>
                                     <div className="w-1.5 bg-blue-500 animate-[bounce_1.2s_infinite] h-6"></div>
                                     <div className="w-1.5 bg-blue-500 animate-[bounce_0.8s_infinite] h-3"></div>
                                </div>
                                <p className="text-sm text-gray-400">æ­£åœ¨æ’­æ”¾ ({speechRate}x)...</p>
                            </div>
                        ) : (
                            <div className="w-full max-w-xs animate-[fadeIn_0.3s_ease-out]">
                                <div className="flex gap-2 mb-4">
                                    <input 
                                        type="number" 
                                        value={userInput} 
                                        onChange={(e) => setUserInput(e.target.value)}
                                        className="flex-1 p-3 border-2 border-gray-200 rounded-xl text-center text-xl outline-none focus:border-blue-500 focus:bg-white transition-colors bg-white"
                                        placeholder="è¾“å…¥æ¬¡æ•°"
                                    />
                                    <Button onClick={checkAnswer} disabled={!userInput}>ç¡®è®¤</Button>
                                </div>
                            </div>
                        )}

                        {result === 'correct' && (
                            <div className="w-full bg-green-100 p-4 rounded-xl text-green-700 text-center animate-bounce mb-4">
                                âœ… æ­£ç¡®ï¼
                                <button onClick={generateGame} className="block w-full mt-2 underline font-bold">ä¸‹ä¸€é¢˜</button>
                            </div>
                        )}
                        {result === 'wrong' && (
                            <div className="w-full bg-red-100 p-4 rounded-xl text-red-700 text-center mb-4">
                                âŒ é”™è¯¯ã€‚æ­£ç¡®æ˜¯ {sequence.answer} æ¬¡ã€‚
                                <button onClick={generateGame} className="block w-full mt-2 underline font-bold">å†è¯•ä¸€æ¬¡</button>
                            </div>
                        )}
                    </div>
                    
                    <div className="py-4">
                        <Button variant="secondary" onClick={() => {setTargetNum(null); setResult(null);}} className="w-full">è°ƒæ•´è®¾ç½®</Button>
                    </div>
                </div>
            )}
        </GameLayout>
    );
};

// --- æ¨¡å—5: é•œåƒç”»æ¿ ---
const MirrorGame = ({ onBack }) => {
    const canvasRef = useRef(null);
    
    useEffect(() => {
        const canvas = canvasRef.current;
        const container = canvas.parentElement;
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, 0);
        ctx.lineTo(canvas.width / 2, canvas.height);
        ctx.strokeStyle = '#cbd5e1';
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
    }, []);

    const getPos = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    };

    const startDraw = (e) => {
        // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè®©é¡µé¢å¯ä»¥æ»šåŠ¨ï¼Œé™¤éåœ¨ç”»æ¿åŒºåŸŸå†…
        const { x, y } = getPos(e);
        const ctx = canvasRef.current.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#2563eb';
    };

    const draw = (e) => {
        e.preventDefault(); // ç»˜ç”»æ—¶é˜»æ­¢æ»šåŠ¨
        const { x, y } = getPos(e);
        const ctx = canvasRef.current.getContext('2d');
        const width = canvasRef.current.width;

        ctx.lineTo(x, y);
        ctx.stroke();

        ctx.fillStyle = '#ef4444'; 
        ctx.fillRect(width - x, y, 3, 3);
        
        ctx.beginPath();
        ctx.moveTo(x, y);
    };

    const clearCanvas = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, 0);
        ctx.lineTo(canvas.width / 2, canvas.height);
        ctx.strokeStyle = '#cbd5e1';
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
    };

    return (
        <GameLayout title="é•œåƒç”»æ¿" icon={Icons.Split} onBack={onBack} headerRight={<button onClick={clearCanvas} className="text-sm bg-gray-100 text-gray-600 px-3 py-1 rounded-lg">æ¸…ç©º</button>}>
             <div className="flex-1 bg-white shadow-inner rounded-xl border border-gray-200 overflow-hidden relative touch-none min-h-[400px]">
                <canvas
                    ref={canvasRef}
                    className="w-full h-full block"
                    onTouchStart={startDraw}
                    onTouchMove={draw}
                    onMouseDown={startDraw}
                    onMouseMove={(e) => { if(e.buttons === 1) draw(e); }}
                />
                 <div className="absolute top-2 left-2 text-xs text-blue-500 font-bold opacity-50 pointer-events-none">å·¦è„‘åŒº</div>
                 <div className="absolute top-2 right-2 text-xs text-red-500 font-bold opacity-50 pointer-events-none">å³è„‘åŒº</div>
            </div>
            <p className="text-center text-xs text-gray-400 mt-2">å•æŒ‡ç»˜ç”»ï¼Œè‡ªåŠ¨ç”Ÿæˆé•œåƒ</p>
        </GameLayout>
    );
};

// --- æ¨¡å—6: è§„åˆ™åˆ†ç±» ---
const ClassifyGame = ({ onBack }) => {
    const items = [
        { name: 'é“…ç¬”', cat: 'æ–‡å…·', price: 2 },
        { name: 'ç¬”è®°æœ¬', cat: 'æ–‡å…·', price: 15 },
        { name: 'è‹¹æœ', cat: 'é£Ÿå“', price: 5 },
        { name: 'ç‰›è‚‰', cat: 'é£Ÿå“', price: 50 },
        { name: 'ç‰™è†', cat: 'æ—¥ç”¨', price: 12 },
        { name: 'æ¯›å·¾', cat: 'æ—¥ç”¨', price: 8 },
    ];

    const [currentItem, setCurrentItem] = useState(null);
    const [rule, setRule] = useState(0); 
    const [score, setScore] = useState(0);
    const [feedback, setFeedback] = useState('');

    const rules = [
        { title: 'åˆ†ç±»ï¼šé£Ÿå“ vs å…¶ä»–', check: (item) => item.cat === 'é£Ÿå“', left: 'é£Ÿå“', right: 'å…¶ä»–' },
        { title: 'ä»·æ ¼ï¼šå¤§äº10å…ƒ vs å°äº10å…ƒ', check: (item) => item.price > 10, left: 'é«˜ä»·(>10)', right: 'ä½ä»·(<=10)' }
    ];

    const nextItem = () => {
        const item = items[Math.floor(Math.random() * items.length)];
        setCurrentItem(item);
        if(Math.random() > 0.7) setRule(r => r === 0 ? 1 : 0);
    };

    useEffect(() => {
        nextItem();
    }, []);

    const handleSort = (dir) => {
        const currentRule = rules[rule];
        const isLeftCorrect = currentRule.check(currentItem);
        
        let correct = false;
        if (dir === 'left' && isLeftCorrect) correct = true;
        if (dir === 'right' && !isLeftCorrect) correct = true;

        if (correct) {
            setScore(s => s + 1);
            setFeedback('âœ¨');
            setTimeout(() => setFeedback(''), 300);
            nextItem();
        } else {
            setScore(s => Math.max(0, s - 1));
            setFeedback('âŒ');
            setTimeout(() => setFeedback(''), 300);
        }
    };

    return (
        <GameLayout title="è§„åˆ™åˆ†ç±»" icon={Icons.Split} onBack={onBack} headerRight={<span className="font-mono text-blue-600 font-bold">{score}åˆ†</span>}>
            <div className="flex-1 flex flex-col items-center justify-between py-4">
                <div className="bg-blue-50 px-4 py-2 rounded-lg text-center w-full">
                    <span className="text-xs text-gray-500 uppercase tracking-wider block mb-1">å½“å‰è§„åˆ™</span>
                    <h3 className="text-md font-bold text-blue-800">{rules[rule].title}</h3>
                </div>

                <div className="relative w-full flex justify-center py-8">
                    {feedback && <div className="absolute top-0 text-5xl animate-ping z-10">{feedback}</div>}
                    
                    {currentItem && (
                        <div className="w-40 h-40 bg-white rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center justify-center transform transition-all">
                            <div className="text-3xl font-bold mb-2">{currentItem.name}</div>
                            <div className="text-sm text-gray-400">Â¥ {currentItem.price}</div>
                        </div>
                    )}
                </div>

                <div className="flex w-full gap-4">
                    <Button onClick={() => handleSort('left')} className="flex-1 h-20 text-lg" variant="secondary">
                        ğŸ‘ˆ {rules[rule].left}
                    </Button>
                    <Button onClick={() => handleSort('right')} className="flex-1 h-20 text-lg" variant="secondary">
                        {rules[rule].right} ğŸ‘‰
                    </Button>
                </div>
            </div>
        </GameLayout>
    );
};

// --- æ¨¡å—7: æƒ…æ™¯è”æƒ³ ---
const StoryGame = ({ onBack }) => {
    const nouns = ['é›¨ä¼', 'ç«è½¦', 'è‹¹æœ', 'å¤§è±¡', 'æ‰‹è¡¨', 'äº‘æœµ', 'å‰ä»–', 'çœ¼é•œ', 'é¦™è•‰', 'ç«ç®­'];
    const [words, setWords] = useState([]);
    const [showWords, setShowWords] = useState(false);

    const generate = () => {
        const shuffled = [...nouns].sort(() => 0.5 - Math.random());
        setWords(shuffled.slice(0, 3));
        setShowWords(true);
    };

    return (
         <GameLayout title="æƒ…æ™¯è”æƒ³" icon={Icons.BookOpen} onBack={onBack}>
            {!showWords ? (
                 <div className="flex-1 flex flex-col justify-center items-center">
                    <div className="bg-white p-6 rounded-2xl shadow-sm w-full text-center">
                        <p className="mb-6 text-gray-600">
                            ç”Ÿæˆ3ä¸ªè¯è¯­ï¼Œç¼–ç»‡ä¸€ä¸ªè’è¯æ•…äº‹å°†å®ƒä»¬ä¸²è”èµ·æ¥ã€‚
                        </p>
                        <Button onClick={generate} className="w-full">ç”Ÿæˆè¯è¯­</Button>
                    </div>
                </div>
            ) : (
                <div className="flex-1 flex flex-col items-center">
                    <div className="grid gap-4 w-full mb-6">
                        {words.map((w, i) => (
                            <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4 animate-[slideIn_0.3s_ease-out]" style={{animationDelay: `${i*0.1}s`}}>
                                <div className="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">{i+1}</div>
                                <div className="text-xl font-bold text-gray-800">{w}</div>
                            </div>
                        ))}
                    </div>

                    <div className="bg-yellow-50 p-4 rounded-xl text-sm text-yellow-800 mb-6 w-full">
                        ğŸ’¡ æç¤ºï¼šé—­çœ¼æƒ³è±¡ç”»é¢ã€‚è¶Šå¤¸å¼ ã€æ„Ÿå®˜è¶Šä¸°å¯Œï¼Œè®°å¿†è¶Šæ·±åˆ»ã€‚
                    </div>

                    <div className="mt-auto w-full flex gap-3">
                        <Button onClick={() => setShowWords(false)} variant="secondary" className="flex-1">å®Œæˆ</Button>
                        <Button onClick={generate} className="flex-1">æ¢ä¸€ç»„</Button>
                    </div>
                </div>
            )}
        </GameLayout>
    );
};

// --- ä¸»èœå• ---
export default function App() {
    const [currentModule, setCurrentModule] = useState(null);

    const modules = [
        { id: 'schulte', title: 'è§†è§‰æœç´¢', desc: 'èˆ’å°”ç‰¹è¡¨è®­ç»ƒ', icon: Icons.Eye, color: 'text-blue-500', bg: 'bg-blue-50' },
        { id: 'stroop', title: 'Stroopæµ‹è¯•', desc: 'æŠ—å¹²æ‰°æ³¨æ„åŠ›', icon: Icons.Zap, color: 'text-yellow-500', bg: 'bg-yellow-50' },
        { id: 'memory', title: 'åºåˆ—è®°å¿†', desc: 'å·¥ä½œè®°å¿†å¹¿åº¦', icon: Icons.Brain, color: 'text-purple-500', bg: 'bg-purple-50' },
        { id: 'auditory', title: 'å¬è§‰ä¸“æ³¨', desc: 'é€‰æ‹©æ€§æ³¨æ„', icon: Icons.Ear, color: 'text-green-500', bg: 'bg-green-50' },
        { id: 'mirror', title: 'é•œåƒåè°ƒ', desc: 'å·¦å³è„‘ååŒ', icon: Icons.PenTool, color: 'text-pink-500', bg: 'bg-pink-50' },
        { id: 'classify', title: 'é€»è¾‘åˆ†ç±»', desc: 'å‰é¢å¶è§„åˆ™', icon: Icons.Split, color: 'text-indigo-500', bg: 'bg-indigo-50' },
        { id: 'story', title: 'æƒ…æ™¯è”æƒ³', desc: 'æµ·é©¬ä½“è®°å¿†', icon: Icons.BookOpen, color: 'text-orange-500', bg: 'bg-orange-50' },
    ];

    const renderModule = () => {
        switch(currentModule) {
            case 'schulte': return <SchulteGame onBack={() => setCurrentModule(null)} />;
            case 'stroop': return <StroopGame onBack={() => setCurrentModule(null)} />;
            case 'memory': return <MemoryGame onBack={() => setCurrentModule(null)} />;
            case 'auditory': return <AuditoryGame onBack={() => setCurrentModule(null)} />;
            case 'mirror': return <MirrorGame onBack={() => setCurrentModule(null)} />;
            case 'classify': return <ClassifyGame onBack={() => setCurrentModule(null)} />;
            case 'story': return <StoryGame onBack={() => setCurrentModule(null)} />;
            default: return null;
        }
    };

    return (
        <div className="h-screen w-full overflow-hidden bg-gray-100 font-sans touch-manipulation">
            <style>{`
                /* éšè—æ»šåŠ¨æ¡ */
                .scrollbar-hide::-webkit-scrollbar { display: none; }
                .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
                .animate-shake { animation: shake 0.3s ease-in-out; }
            `}</style>

            {currentModule ? (
                renderModule()
            ) : (
                <div className="flex flex-col h-full bg-gray-100">
                    <div className="flex-1 overflow-y-auto p-4 scrollbar-hide">
                         <header className="mb-6 pt-2">
                            <h1 className="text-2xl font-bold text-gray-900 mb-1">å¤§è„‘å¥èº«æˆ¿ ğŸ§ </h1>
                            <p className="text-sm text-gray-500">PhD ä¸“å±å£è¢‹è®­ç»ƒè¥</p>
                        </header>

                        <div className="grid gap-3 pb-8">
                            {modules.map((m) => (
                                <button
                                    key={m.id}
                                    onClick={() => setCurrentModule(m.id)}
                                    className="bg-white p-4 rounded-xl shadow-sm active:scale-95 transition-transform flex items-center gap-4 text-left border border-transparent hover:border-blue-100"
                                >
                                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0 ${m.bg} ${m.color}`}>
                                        <m.icon />
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="font-bold text-gray-800">{m.title}</h3>
                                        <p className="text-xs text-gray-500">{m.desc}</p>
                                    </div>
                                    <div className="text-gray-300">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                     <div className="bg-white p-3 text-center text-xs text-gray-400 border-t border-gray-100 shrink-0">
                        ä¿æŒæ¯æ—¥è®­ç»ƒï¼Œæ¿€æ´»å‰é¢å¶ä¸æµ·é©¬ä½“
                    </div>
                </div>
            )}
        </div>
    );
}
